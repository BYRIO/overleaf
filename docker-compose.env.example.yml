version: "3.9"

services:
  overleaf:
    image: sharelatex/sharelatex
    container_name: overleaf
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "80:80"
    volumes:
      - ./data/overleaf:/var/lib/overleaf
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Core
      OVERLEAF_APP_NAME: "BYRIO OVERLEAF"
      OVERLEAF_SITE_URL: "http://localhost"
      OVERLEAF_NAV_TITLE: "BYRIO OVERLEAF"
      OVERLEAF_ADMIN_EMAIL: "admin@example.com"
      OVERLEAF_SESSION_SECRET: "replace-with-random-string"
      OVERLEAF_MONGO_URL: "mongodb://mongo/sharelatex"
      OVERLEAF_REDIS_HOST: "redis"
      ENABLED_LINKED_FILE_TYPES: "project_file,project_output_file"
      EMAIL_CONFIRMATION_DISABLED: "true"
      OVERLEAF_ALLOW_PUBLIC_ACCESS: "true"
      OVERLEAF_ALLOW_ANONYMOUS_READ_AND_WRITE_SHARING: "false"
      OVERLEAF_COOKIE_SESSION_LENGTH: "432000000" # 5 days in ms
      OVERLEAF_TRUSTED_PROXY_IPS: "loopback"
      OVERLEAF_SECURE_COOKIE: ""
      OVERLEAF_SITE_LANGUAGE: "en"
      OVERLEAF_MAINTENANCE_MESSAGE: ""
      OVERLEAF_STATUS_PAGE_URL: ""

      # Branding and UI (optional)
      OVERLEAF_HEADER_IMAGE_URL: ""
      OVERLEAF_LEFT_FOOTER: ""
      OVERLEAF_RIGHT_FOOTER: ""
      OVERLEAF_LOGIN_SUPPORT_TITLE: ""
      OVERLEAF_LOGIN_SUPPORT_TEXT: ""

      # Security and auth
      SESSION_SECRET: "replace-with-random-string"
      BCRYPT_ROUNDS: "12"
      BLOCK_CROSS_ORIGIN_REQUESTS: "false"
      ALLOWED_ORIGINS: "http://localhost"

      # Email (SMTP example; leave empty to disable outbound mail)
      OVERLEAF_EMAIL_FROM_ADDRESS: "noreply@example.com"
      OVERLEAF_EMAIL_DRIVER: "smtp"
      OVERLEAF_EMAIL_SMTP_HOST: "smtp.example.com"
      OVERLEAF_EMAIL_SMTP_PORT: "587"
      OVERLEAF_EMAIL_SMTP_SECURE: "false"
      OVERLEAF_EMAIL_SMTP_IGNORE_TLS: "false"
      OVERLEAF_EMAIL_SMTP_USER: "smtp-user"
      OVERLEAF_EMAIL_SMTP_PASS: "smtp-pass"
      OVERLEAF_EMAIL_REPLY_TO: ""
      OVERLEAF_EMAIL_SMTP_TLS_REJECT_UNAUTH: "true"
      OVERLEAF_CUSTOM_EMAIL_FOOTER: ""

      # Compile / Tex Live / sandbox
      SANDBOX_ENABLED: "true"
      SANDBOX_DOCKER_RUNNER: "true"
      SANDBOX_SIBLING_CONTAINERS: "true"
      DOCKER_SOCKET_PATH: "/var/run/docker.sock"
      TEX_LIVE_DOCKER_IMAGE: "texlive/texlive:latest-full"
      ALL_TEX_LIVE_DOCKER_IMAGES: "texlive/texlive:latest-full"
      ALL_TEX_LIVE_DOCKER_IMAGE_NAMES: "TeXLive Latest"
      TEX_LIVE_IMAGE_USER: "www-data"
      TEX_COMPILER_EXTRA_FLAGS: "-shell-escape"
      AUTO_PULL_TEXLIVE_IMAGE: "false"
      FAIL_ON_MISSING_TEXLIVE_IMAGE: "false"
      FAIL_ON_IMAGE_PULL_FAILURE: "false"
      AUTO_BACKFILL_TEXLIVE_IMAGE: "true"
      AUTO_FALLBACK_TEXLIVE_IMAGE: "true"
      SANDBOXED_COMPILES_HOST_DIR_COMPILES: "/var/lib/overleaf/data/compiles"
      SANDBOXED_COMPILES_HOST_DIR_OUTPUT: "/var/lib/overleaf/data/output"
      OVERLEAF_HOST_DATA_DIR: "/var/lib/overleaf"
      COMPILE_TIMEOUT: "180"

      # Texlab (LaTeX LSP, optional)
      TEXLAB_PATH: "/usr/local/bin/texlab"
      TEXLAB_ARGS: ""
      TEXLAB_RESPONSE_TIMEOUT_MS: "20000"
      TEXLAB_IDLE_MS: "1200000"
      TEXLAB_MAX_PROCS: "4"
      TEXLAB_WORKSPACE_TTL_MS: "300000"
      TEXLAB_WORKDIR_BASE: "/var/lib/overleaf/tmp/texlab"
      TEXLAB_PROJECT_ROOT: "/var/lib/overleaf/data"
      TEXLAB_LOG_PATH: "/var/log/overleaf/texlab.log"

      # LLM chat (optional)
      LLM_AVAILABLE_MODELS: ""
      LLM_API_URL: ""
      LLM_API_KEY: ""

      # Gitbackup (optional sidecar managed by overleaf container)
      GITBACKUP_ENABLED: "false"
      GITBACKUP_IMAGE: "sharelatex/sharelatex-gitbackup:latest"
      GITBACKUP_CONTAINER_NAME: "gitbackup"
      GITBACKUP_SSH_PORT: "2222"
      GITBACKUP_PUID: "1000"
      GITBACKUP_PGID: "1000"
      GITBACKUP_DATA_DIR: "/var/lib/overleaf/gitbackup"
      GITBACKUP_HOST_DATA_DIR: "/var/lib/overleaf/gitbackup"
      GITBACKUP_HOST_LOG_DIR: "/var/lib/overleaf/gitbackup/log"
      GITBACKUP_HOST_ETC_DIR: "/var/lib/overleaf/gitbackup/etc"
      GITBACKUP_CHECK_INTERVAL: "30000"
      GITBACKUP_PULL_IMAGE: "false"
      DOCKER_NETWORK: "bridge"

      # LDAP (optional)
      OVERLEAF_LDAP_URL: ""
      OVERLEAF_LDAP_SEARCH_BASE: ""
      OVERLEAF_LDAP_SEARCH_FILTER: ""
      OVERLEAF_LDAP_BIND_DN: ""
      OVERLEAF_LDAP_BIND_CREDENTIALS: ""
      OVERLEAF_LDAP_EMAIL_ATT: "mail"
      OVERLEAF_LDAP_NAME_ATT: "cn"
      OVERLEAF_LDAP_LAST_NAME_ATT: "sn"
      OVERLEAF_LDAP_UPDATE_USER_DETAILS_ON_LOGIN: "true"

      # Object storage (optional S3-compatible)
      OVERLEAF_FILESTORE_BACKEND: "fs"
      OVERLEAF_FILESTORE_TEMPLATE_FILES_BUCKET_NAME: ""
      OVERLEAF_HISTORY_PROJECT_BLOBS_BUCKET: ""
      OVERLEAF_HISTORY_BLOBS_BUCKET: ""
      OVERLEAF_FILESTORE_S3_ACCESS_KEY_ID: ""
      OVERLEAF_FILESTORE_S3_SECRET_ACCESS_KEY: ""
      OVERLEAF_FILESTORE_S3_ENDPOINT: ""
      OVERLEAF_FILESTORE_S3_REGION: ""
      OVERLEAF_FILESTORE_S3_PATH_STYLE: "false"

      # History/backup tuning
      OVERLEAF_HISTORY_V1_HTTP_REQUEST_TIMEOUT: "300000"
      V1_HISTORY_URL: "http://127.0.0.1:3100/api"
      STAGING_PASSWORD: ""
      OVERLEAF_REDIS_LOCK_TTL_SECONDS: "60"

      # Registration throttling (optional)
      SELF_REGISTER_ALLOWED_DOMAINS: "bupt.edu.cn"
      SELF_REGISTER_RATE_POINTS: "5"
      SELF_REGISTER_RATE_DURATION: "3600"
      SELF_REGISTER_RATE_BLOCK_DURATION: "3600"
      CONTACT_SUPPORT_TEXT: ""

      # HTTPS/reverse proxy helper (optional)
      VIRTUAL_HOST: ""

  mongo:
    image: mongo:6.0
    container_name: mongo
    restart: unless-stopped
    command: "--replSet overleaf"
    environment:
      MONGO_INITDB_DATABASE: "sharelatex"
    volumes:
      - ./data/mongo:/data/db
      - ./bin/shared/mongodb-init-replica-set.js:/docker-entrypoint-initdb.d/mongodb-init-replica-set.js
    extra_hosts:
      - "mongo:127.0.0.1"
    healthcheck:
      test: ["CMD-SHELL", "echo 'db.stats().ok' | mongosh localhost:27017/test --quiet"]
      interval: 10s
      timeout: 10s
      retries: 5

  redis:
    image: redis:6.2
    container_name: redis
    restart: unless-stopped
    volumes:
      - ./data/redis:/data

# Optional test LDAP server
#  ldap:
#    image: rroemhild/test-openldap
#    container_name: ldap
#    restart: unless-stopped
